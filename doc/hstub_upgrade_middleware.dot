digraph hstub_upgrade_middleware {
        request [shape=Mdiamond];
        has_connection_header [shape=diamond];
        has_upgrade_header [shape=diamond];
        execute [label="execute/2"]
        request -> execute;
        execute -> get_connection_header;
        
        get_connection_header -> has_connection_header;
        has_connection_header -> continue [label="No"];
        has_connection_header -> get_upgrade_header [label="Yes"];

        get_upgrade_header -> has_upgrade_header;
        has_upgrade_header -> set_request_meta [label="Yes"];
        has_upgrade_header -> response_400 [label="No"];
        set_request_meta -> continue;
        continue [shape=cds];
        response_400 -> end;
        end [shape=Msquare];
}